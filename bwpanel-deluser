#!/bin/bash
# BWPanel CLI - Remover usuário e site
# Uso: bwpanel-deluser <usuario>

CONFIG_FILE="/opt/bwpanel/config.conf"
if [ ! -f "$CONFIG_FILE" ]; then
  echo "Erro: Arquivo de configuração não encontrado em $CONFIG_FILE"
  exit 1
fi
source "$CONFIG_FILE"

USER=$1
if [ -z "$USER" ]; then
  echo "Uso: bwpanel-deluser <usuario>"
  exit 1
fi

# Obter domínio a partir do padrão (busca no diretório)
DOMAIN=$(ls "$SITES_PATH" | grep "_${USER}_" | head -n 1)
if [ -z "$DOMAIN" ]; then
  echo "Erro: Usuário '$USER' não encontrado ou não possui sites."
  exit 1
fi

SITE_PATH="${SITES_PATH}/${DOMAIN}"
DB_NAME="db_${DOMAIN}"
DB_USER="user_${DOMAIN}"
CONF_FILE="${NGINX_AVAILABLE}/${DOMAIN}.conf"

# Deletar banco e usuário
mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" <<MYSQL_SCRIPT
DROP DATABASE IF EXISTS \`${DB_NAME}\`;
DROP USER IF EXISTS '${DB_USER}'@'localhost';
FLUSH PRIVILEGES;
MYSQL_SCRIPT

# Remover diretórios e configs
rm -rf "$SITE_PATH"
rm -f "$CONF_FILE"
rm -f "${NGINX_ENABLED}/${DOMAIN}.conf"

nginx -t && systemctl reload nginx

echo "Usuário e site removidos com sucesso!"
