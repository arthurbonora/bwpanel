#!/bin/bash
# BWPanel CLI - Criar novo usuário e site
# Uso: bwpanel-adduser <usuario> <email> <senha> <dominio>

CONFIG_FILE="/opt/bwpanel/config.conf"
if [ ! -f "$CONFIG_FILE" ]; then
  echo "Erro: Arquivo de configuração não encontrado em $CONFIG_FILE"
  exit 1
fi
source "$CONFIG_FILE"

USER=$1
EMAIL=$2
PASSWORD=$3
DOMAIN=$4

if [ -z "$USER" ] || [ -z "$EMAIL" ] || [ -z "$PASSWORD" ] || [ -z "$DOMAIN" ]; then
  echo "Uso: bwpanel-adduser <usuario> <email> <senha> <dominio>"
  exit 1
fi

DB_NAME="db_${DOMAIN//./_}"
DB_USER="user_${DOMAIN//./_}"
DB_PASS=$(openssl rand -base64 14)
SITE_PATH="${SITES_PATH}/${DOMAIN//./_}"

echo "---------------------------------------------"

# Criar banco e usuário
mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" <<MYSQL_SCRIPT
CREATE DATABASE \`${DB_NAME}\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER '${DB_USER}'@'localhost' IDENTIFIED BY '${DB_PASS}';
GRANT ALL PRIVILEGES ON \`${DB_NAME}\`.* TO '${DB_USER}'@'localhost';
FLUSH PRIVILEGES;
MYSQL_SCRIPT

# Criar diretório do site
mkdir -p "$SITE_PATH/public_html"
mkdir -p "$SITE_PATH/logs"

# Criar arquivo de exemplo
echo "<h1>Bem-vindo ao site ${DOMAIN}</h1>" > "$SITE_PATH/public_html/index.php"

# Criar config nginx
CONF_FILE="${NGINX_AVAILABLE}/${DOMAIN//./_}.conf"
cat > "$CONF_FILE" <<EOF
server {
    server_name ${DOMAIN};
    root ${SITE_PATH}/public_html;

    index index.php index.html;
    access_log ${SITE_PATH}/logs/access.log;
    error_log ${SITE_PATH}/logs/error.log;

    location / {
        try_files \$uri \$uri/ /index.php?\$query_string;
    }

    location ~ \.php\$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.4-fpm.sock;
    }
}
EOF

ln -sf "$CONF_FILE" "${NGINX_ENABLED}/"
nginx -t && systemctl reload nginx

# Inserir usuário no banco principal
mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" <<MYSQL_SCRIPT
INSERT INTO users (username, email, password, client_id)
VALUES ('$USER', '$EMAIL', MD5('$PASSWORD'), NULL);
MYSQL_SCRIPT

echo "Usuário e site criados com sucesso!"
echo "Usuário BWPanel: $USER"
echo "Domínio: $DOMAIN"
echo "Caminho do site: $SITE_PATH"
echo "Banco de dados: $DB_NAME"
echo "Usuário DB: $DB_USER"
echo "Senha DB: $DB_PASS"
echo "---------------------------------------------"
