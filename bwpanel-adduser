#!/bin/bash
# BWPanel CLI - Adicionar novo usu√°rio e site
# Uso: sudo bwpanel-adduser <usuario> <email> <senha> <dominio> <package>

CONFIG_FILE="/opt/bwpanel/config.conf"
source "$CONFIG_FILE"

if [ "$#" -lt 5 ]; then
    echo "Uso: sudo bwpanel-adduser <usuario> <email> <senha> <dominio> <package>"
    exit 1
fi

USERNAME=$1
EMAIL=$2
PASSWORD=$3
DOMAIN=$4
PACKAGE=$5

DB_PASS_REAL=$DB_PASS

SITE_PATH="${SITES_PATH}/${DOMAIN//./_}"
DB_NAME="db_${DOMAIN//./_}"
DB_USER="user_${DOMAIN//./_}"
DB_PASS=$(openssl rand -base64 16)

echo "---------------------------------------------"

# üîπ Verifica se o pacote existe
PACKAGE_ID=$(mysql -u $DB_USER -p$DB_PASS_REAL -D $DB_NAME --batch --skip-column-names -e "SELECT id FROM packages WHERE name='${PACKAGE}' LIMIT 1;")

if [ -z "$PACKAGE_ID" ]; then
    echo "‚ùå Pacote '${PACKAGE}' n√£o encontrado. Crie o pacote primeiro com 'bwpanel-addpackage'."
    exit 1
fi

# üîπ Cria pasta do site
sudo mkdir -p "$SITE_PATH/public_html"
sudo mkdir -p "$SITE_PATH/logs"
sudo chown -R www-data:www-data "$SITE_PATH"

# üîπ Cria banco e usu√°rio espec√≠ficos do site
mysql -u root -p <<MYSQL_SCRIPT
CREATE DATABASE IF NOT EXISTS \`${DB_NAME}\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER IF NOT EXISTS '${DB_USER}'@'localhost' IDENTIFIED BY '${DB_PASS}';
GRANT ALL PRIVILEGES ON \`${DB_NAME}\`.* TO '${DB_USER}'@'localhost';
FLUSH PRIVILEGES;
MYSQL_SCRIPT

# üîπ Cria usu√°rio no banco principal
HASHED_PASS=$(php -r "echo password_hash('$PASSWORD', PASSWORD_DEFAULT);")

mysql -u $DB_USER -p$DB_PASS_REAL -D $DB_NAME <<MYSQL_SCRIPT
USE bwpanel;
INSERT INTO users (username, email, password, package_id, created_at)
VALUES ('$USERNAME', '$EMAIL', '$HASHED_PASS', '$PACKAGE_ID', NOW());
MYSQL_SCRIPT

# üîπ Cria registro do site
mysql -u $DB_USER -p$DB_PASS_REAL -D $DB_NAME <<MYSQL_SCRIPT
USE bwpanel;
INSERT INTO sites (domain, path, user_id, db_name, db_user, db_pass)
VALUES ('$DOMAIN', '$SITE_PATH', (SELECT id FROM users WHERE username='$USERNAME'), '$DB_NAME', '$DB_USER', '$DB_PASS');
MYSQL_SCRIPT

# üîπ Cria configura√ß√£o NGINX
CONF_FILE="${NGINX_AVAILABLE}/${DOMAIN//./_}.conf"
cat > "$CONF_FILE" <<EOL
server {
    listen 80;
    server_name $DOMAIN;
    root $SITE_PATH/public_html;
    index index.php index.html;

    access_log $SITE_PATH/logs/access.log;
    error_log $SITE_PATH/logs/error.log;

    location / {
        try_files \$uri \$uri/ /index.php?\$query_string;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.4-fpm.sock;
    }

    location ~ /\.ht {
        deny all;
    }
}
EOL

sudo ln -sf "$CONF_FILE" "$NGINX_ENABLED/"
sudo systemctl reload nginx

echo "---------------------------------------------"
echo "‚úÖ Usu√°rio e site criados com sucesso!"
echo "Usu√°rio BWPanel: $USERNAME"
echo "Dom√≠nio: $DOMAIN"
echo "Caminho do site: $SITE_PATH"
echo "Banco de dados: $DB_NAME"
echo "Usu√°rio DB: $DB_USER"
echo "Senha DB: $DB_PASS"
echo "Pacote: $PACKAGE"
echo "---------------------------------------------"
