#!/bin/bash
# BWPanel CLI - Atualizador oficial
VERSION_LOCAL="1.0.0"
AUTHOR="Bonora SoluÃ§Ãµes Web"
REPO_BASE="https://raw.githubusercontent.com/arthurbonora/bwpanel/main"
INSTALL_DIR="/opt/bwpanel"
BACKUP_DIR="/opt/bwpanel/backups"

echo ""
echo "============================================="
echo "      ðŸŒ BWPanel CLI - AtualizaÃ§Ã£o"
echo "============================================="
echo ""
echo "Autor: $AUTHOR"
echo "VersÃ£o atual: $VERSION_LOCAL"
echo ""

mkdir -p "$BACKUP_DIR"
TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
BACKUP_FILE="$BACKUP_DIR/bwpanel_backup_$TIMESTAMP.tar.gz"

echo "ðŸ“¦ Criando backup dos scripts atuais..."
tar -czf "$BACKUP_FILE" "$INSTALL_DIR"/bwpanel-* >/dev/null 2>&1
echo "âœ… Backup salvo em: $BACKUP_FILE"
echo ""

SCRIPTS=(
  "bwpanel-install"
  "bwpanel-adduser"
  "bwpanel-deluser"
  "bwpanel-help"
  "bwpanel-version"
  "bwpanel-update"
  "bwpanel-package"
)

echo "â¬‡ï¸  Baixando scripts atualizados do repositÃ³rio..."
for script in "${SCRIPTS[@]}"; do
    echo "- Atualizando: $script"
    curl -s -o "$INSTALL_DIR/$script" "$REPO_BASE/bin/$script"
    if [ $? -eq 0 ]; then
        chmod +x "$INSTALL_DIR/$script"
    else
        echo "âš ï¸  Falha ao baixar $script"
    fi
done

chown root:root "$INSTALL_DIR"/bwpanel-* 2>/dev/null
chmod +x "$INSTALL_DIR"/bwpanel-* 2>/dev/null

LATEST_VERSION=$(curl -s "$REPO_BASE/version.txt" | head -n 1)
if [ -n "$LATEST_VERSION" ] && [ "$LATEST_VERSION" != "$VERSION_LOCAL" ]; then
    echo ""
    echo "ðŸš€ AtualizaÃ§Ã£o concluÃ­da! Nova versÃ£o disponÃ­vel: $LATEST_VERSION"
else
    echo ""
    echo "âœ… Nenhuma nova versÃ£o detectada (versÃ£o atual: $VERSION_LOCAL)."
fi

# Reinicia serviÃ§os principais
echo ""
echo "ðŸ” Reiniciando serviÃ§os..."
systemctl reload nginx >/dev/null 2>&1
systemctl restart php8.3-fpm >/dev/null 2>&1
systemctl restart mariadb >/dev/null 2>&1
echo "âœ… ServiÃ§os reiniciados."

echo ""
echo "============================================="
echo "BWPanel CLI atualizado com sucesso!"
echo "============================================="
echo ""
