#!/bin/bash
# BWPanel CLI - Instalador Completo
# Uso: sudo bwpanel-install

INSTALL_DIR="/opt/bwpanel"
CONFIG_FILE="$INSTALL_DIR/config.conf"
SCRIPTS=("bwpanel-adduser" "bwpanel-deluser" "bwpanel-help" "bwpanel-version" "bwpanel-update")

echo "============================================="
echo "ðŸŒ BWPanel CLI - Instalador Completo"
echo "============================================="

# 1ï¸âƒ£ Criar diretÃ³rio principal
sudo mkdir -p "$INSTALL_DIR"
sudo chown root:root "$INSTALL_DIR"

# 2ï¸âƒ£ Criar config.conf inicial se nÃ£o existir
if [ ! -f "$CONFIG_FILE" ]; then
cat > "$CONFIG_FILE" <<EOL
# BWPanel CLI Configuration
SITES_PATH="/home/bwpanel/sites"
TEMPLATE_PATH="/home/bwpanel/templates"
DB_HOST="localhost"
DB_USER="bwuser"
DB_PASS="SENHA_DO_BWUSER"
DB_NAME="bwpanel"
NGINX_AVAILABLE="/etc/nginx/sites-available"
NGINX_ENABLED="/etc/nginx/sites-enabled"
PHP_FPM_POOL_DIR="/etc/php/8.4/fpm/pool.d"
BWCLI_VERSION="1.0"
EOL
    echo "âœ… Arquivo de configuraÃ§Ã£o inicial criado em $CONFIG_FILE"
else
    echo "âš ï¸ ConfiguraÃ§Ã£o jÃ¡ existente em $CONFIG_FILE. NÃ£o sobrescrevendo."
fi

# 3ï¸âƒ£ Tornar scripts executÃ¡veis e copiar para INSTALL_DIR
for script in "${SCRIPTS[@]}"; do
    if [ -f "./$script" ]; then
        sudo cp "./$script" "$INSTALL_DIR/"
        sudo chmod +x "$INSTALL_DIR/$script"
        echo "âœ… Script $script instalado."
    else
        echo "âš ï¸ Script $script nÃ£o encontrado no diretÃ³rio atual."
    fi
done

# 4ï¸âƒ£ Criar links simbÃ³licos
for script in "${SCRIPTS[@]}"; do
    sudo ln -sf "$INSTALL_DIR/$script" /usr/local/bin/$script
done
echo "âœ… Links simbÃ³licos criados."

# 5ï¸âƒ£ Criar diretÃ³rio padrÃ£o de sites
sudo mkdir -p /home/bwpanel/sites
sudo chown -R www-data:www-data /home/bwpanel/sites
echo "âœ… DiretÃ³rio padrÃ£o de sites criado em /home/bwpanel/sites"

# 6ï¸âƒ£ Criar banco de dados BWPanel e tabelas iniciais
echo "ðŸ”§ Criando banco de dados e tabelas iniciais..."
DB_USER="bwuser"
DB_PASS="SENHA_DO_BWUSER"

mysql -u root -p <<MYSQL_SCRIPT
CREATE DATABASE IF NOT EXISTS bwpanel CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER IF NOT EXISTS '${DB_USER}'@'localhost' IDENTIFIED BY '${DB_PASS}';
GRANT ALL PRIVILEGES ON bwpanel.* TO '${DB_USER}'@'localhost';
FLUSH PRIVILEGES;

USE bwpanel;

-- =========================
-- Tabela de UsuÃ¡rios
-- =========================
CREATE TABLE IF NOT EXISTS users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL,
    password VARCHAR(255) NOT NULL,
    client_id INT DEFAULT NULL,
    package_id INT DEFAULT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- =========================
-- Tabela de Clientes
-- =========================
CREATE TABLE IF NOT EXISTS clients (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- =========================
-- Tabela de Sites
-- =========================
CREATE TABLE IF NOT EXISTS sites (
    id INT AUTO_INCREMENT PRIMARY KEY,
    domain VARCHAR(150) NOT NULL UNIQUE,
    path VARCHAR(255) NOT NULL,
    user_id INT NOT NULL,
    db_name VARCHAR(100) NOT NULL,
    db_user VARCHAR(100) NOT NULL,
    db_pass VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- =========================
-- Tabela de Pacotes (Plans)
-- =========================
CREATE TABLE IF NOT EXISTS packages (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    disk_quota_mb INT DEFAULT 1024,
    max_domains INT DEFAULT 1,
    max_databases INT DEFAULT 1,
    max_email_accounts INT DEFAULT 0,
    max_ftp_accounts INT DEFAULT 1,
    max_subdomains INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
MYSQL_SCRIPT

echo "âœ… Banco de dados e tabelas criadas."

# 7ï¸âƒ£ FinalizaÃ§Ã£o
echo ""
echo "============================================="
echo "ðŸŽ‰ BWPanel CLI instalado com sucesso!"
echo "Use: bwpanel-help para ver todos os comandos"
echo "============================================="
